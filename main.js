(()=>{"use strict";const t=document.querySelector(".profile__edit-button"),e=document.querySelector(".profile__avatar-button"),s=document.querySelector(".profile__add-button"),i=document.querySelector("#cardTemplate"),r=document.querySelector("#profileForm"),n=document.querySelector("#avatarForm"),o=document.querySelector("#cardform");class a{constructor(t,e,s,i,r,n){this._photoCard=t,this._photoCardId=t._id,this._likes=t.likes,this._ownerId=this._photoCard.owner._id,this._cardTemplate=e,this._openZoomPhoto=s,this._handleLike=i,this._handleDeleteCard=r,this._userId=n,this._templateCard=this._defineCard(),this._cardLikesCounter=this._templateCard.querySelector(".card__info-likes-counter"),this._cardHeading=this._templateCard.querySelector(".card__info-title"),this._cardImage=this._templateCard.querySelector(".cards__image"),this._deleteButtonCard=this._templateCard.querySelector(".cards__delete-photo"),this._likeButton=this._templateCard.querySelector(".card__info-likes-button")}_defineCard(){return this._cardTemplate.content.querySelector(".card").cloneNode(!0)}_defineDeleteButton(){this._ownerId!==this._userId&&(this._deleteButtonCard.classList.add("cards__delete-photo_invisible"),this._deleteButtonCard.disabled=!0)}_isCardLiked(){return Boolean(this._likes.find((t=>t._id===this._userId)))}_defineLikeButton(){this._isCardLiked()&&this._likeButton.classList.add("card__info-likes-button_active")}_setCardElements(){this._cardHeading.textContent=this._photoCard.name,this._cardImage.setAttribute("src",this._photoCard.link),this._cardImage.setAttribute("alt",this._photoCard.name)}_setLikesCounter(){this._cardLikesCounter.textContent=this._likes.length}_changeLikesCounter=t=>{this._likes=t,this._cardLikesCounter.textContent=this._likes.length};_changeLikeStatus=()=>{this._likeButton.classList.toggle("card__info-likes-button_active")};_handleDeleteButtonClick=()=>{this._templateCard.remove(),this._templateCard=null};_handleOpenZoomClick(){this._openZoomPhoto(this._photoCard)}_addListeners(){this._likeButton.addEventListener("click",(t=>{this._isCardLiked()?this._handleLike(this._photoCardId,this._changeLikesCounter,this._changeLikeStatus,!0):this._handleLike(this._photoCardId,this._changeLikesCounter,this._changeLikeStatus,!1)})),this._deleteButtonCard.addEventListener("click",(()=>{this._handleDeleteCard(this._photoCardId,this._handleDeleteButtonClick)})),this._cardImage.addEventListener("click",(()=>{this._handleOpenZoomClick()}))}createCard(){return this._defineCard(),this._setCardElements(),this._setLikesCounter(),this._defineDeleteButton(),this._defineLikeButton(),this._addListeners(),this._templateCard}}class h{constructor(t,e){this._inputSelector=t.inputSelector,this._submitButtonSelector=t.submitButtonSelector,this._inactiveButtonClass=t.inactiveButtonClass,this._textErrorClass=t.textErrorClass,this._errorClass=t.errorClass,this._form=e}_defineElements(){this._inputList=this._form.querySelectorAll(this._inputSelector),this._submitButton=this._form.querySelector(this._submitButtonSelector)}_showInputError(t,e,s){t.classList.add(this._errorClass),e.textContent=s}_hideInputError(t,e){t.classList.remove(this._errorClass),e.textContent=""}_enableButton(){this._submitButton.classList.remove(this._inactiveButtonClass),this._submitButton.disabled=!1}disableButton(){this._submitButton.classList.add(this._inactiveButtonClass),this._submitButton.disabled=!0}_getErrorElement(t){return this._form.querySelector(`${this._textErrorClass}${t.name}`)}_checkInputValidity(t){t.validity.valid?this._hideInputError(t,this._getErrorElement(t)):this._showInputError(t,this._getErrorElement(t),t.validationMessage)}_getInvalidInputs(){return 0===[...this._inputList].filter((t=>!t.validity.valid)).length}_toggleButton(){this._getInvalidInputs()?this._enableButton():this.disableButton()}_setEventListeners(){this._inputList.forEach((t=>{t.addEventListener("input",(()=>{this._checkInputValidity(t),this._toggleButton()}))}))}hideErrors(){this._inputList.forEach((t=>{this._hideInputError(t,this._getErrorElement(t))}))}enableValidation(){this._defineElements(),this._setEventListeners()}resetValidation(){this.hideErrors(),this.disableButton()}}class d{constructor(t){this._popup=document.querySelector(t)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){document.removeEventListener("keydown",this._handleEscClose),this._popup.classList.remove("popup_opened")}_handleEscClose=t=>{"Escape"===t.key&&this.close()};setEventListeners(){this._popup.addEventListener("mousedown",(t=>{const e=e=>t.target.classList.contains(e);(e("popup_opened")||e("popup__close"))&&this.close()}))}}class l extends d{constructor(t,e){super(t),this._submitFormCallback=e,this._form=this._popup.querySelector("form"),this._inputs=this._form.querySelectorAll("input"),this._submitButton=this._form.querySelector(".popup__button"),this._submitButtonText=this._submitButton.textContent}_getInputValues(){const t={};return this._inputs.forEach((e=>{t[e.name]=e.value})),t}setInputValues(t){this._inputs.forEach((e=>{e.value=t[e.name]}))}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault(),this._submitFormCallback(this._getInputValues())}))}setSubmitButtonPending(){this._submitButton.textContent=`${this._submitButtonText}...`,this._submitButton.disabled=!0}resetSubmitButton(){this._submitButton.textContent=this._submitButtonText,this._submitButton.disabled=!1}close(){super.close(),this._form.reset()}}const u=new class{constructor(t){this._baseUrl=t.baseUrl,this._headers=t.headers}_checkRes(t){return t.ok?t.json():Promise.reject(`Ошибка: ${t.status}`)}getProfile(){return fetch(`${this._baseUrl}/users/me`,{method:"GET",headers:this._headers}).then((t=>this._checkRes(t)))}editProfile(t){return fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:t.name,about:t.about})}).then((t=>this._checkRes(t)))}editAvatar(t){return fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:t})}).then((t=>this._checkRes(t)))}getInitialCards(){return fetch(`${this._baseUrl}/cards`,{method:"GET",headers:this._headers}).then((t=>this._checkRes(t)))}addCard(t){return fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:t.name,link:t.link})}).then((t=>this._checkRes(t)))}deleteCard(t){return fetch(`${this._baseUrl}/cards/${t}`,{method:"DELETE",headers:this._headers}).then((t=>this._checkRes(t)))}addLike(t){return fetch(`${this._baseUrl}/cards/${t}/likes`,{method:"PUT",headers:this._headers}).then((t=>this._checkRes(t)))}deleteLike(t){return fetch(`${this._baseUrl}/cards/${t}/likes`,{method:"DELETE",headers:this._headers}).then((t=>this._checkRes(t)))}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-65",headers:{authorization:"bad0a43e-1805-4faf-8465-a8ef0cb6b6aa","Content-Type":"application/json"}}),_={};var c;c={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",textErrorClass:".popup__input-error_type_",errorClass:"popup__input_error"},Array.from(document.querySelectorAll(c.formSelector)).forEach((t=>{const e=new h(c,t),s=t.getAttribute("name");_[s]=e,e.enableValidation()}));const p=new class extends d{constructor(t){super(t),this._title=this._popup.querySelector(".popup__title-zoom"),this._image=this._popup.querySelector(".popup__zoom")}open=({name:t,link:e})=>{this._title.textContent=t,this._image.alt=t,this._image.src=e,super.open()}}("#zoomfoto");p.setEventListeners();const m=new class{constructor({nameId:t,aboutId:e,avatarId:s}){this._name=document.querySelector(t),this._about=document.querySelector(e),this._avatar=document.querySelector(s)}getUserInfo(){return{name:this._name.textContent,about:this._about.textContent,userId:this._userId}}getUserId(){return this._userId}setUserInfo=(t,e,s,i)=>{this._name.textContent=t,this._about.textContent=e,this.setAvatar(s),this._userId=i};setAvatar=t=>{this._avatar.src=t}}({nameId:".profile__name",aboutId:".profile__about",avatarId:".profile__avatar"}),b=new class{constructor({renderer:t},e){this._renderer=t,this._container=document.querySelector(e)}renderElements=t=>{t.forEach((t=>{this._container.append(this._renderer(t))}))};addItem(t){this._container.prepend(this._renderer(t))}}({renderer:function(t){return new a(t,i,p.open,v,E.open,m.getUserId()).createCard()}},".cards"),C=new l("#cardADD",(function(t){const e={name:t.name,link:t.link};C.setSubmitButtonPending(),u.addCard(e).then((t=>{b.addItem(t),C.close()})).catch((t=>{console.log(t)})).finally((()=>{C.resetSubmitButton()}))})),f=new l("#profileEdit",(function(t){f.setSubmitButtonPending(),u.editProfile(t).then((t=>{m.setUserInfo(t.name,t.about,t.avatar),f.close()})).catch((t=>{console.log(t)})).finally((()=>{f.resetSubmitButton()}))})),k=new l("#avatarEdit",(function(t){k.setSubmitButtonPending(),u.editAvatar(t.avatar).then((t=>{m.setAvatar(t.avatar),k.close()})).catch((t=>{console.log(t)})).finally((()=>{k.resetSubmitButton()}))}));C.setEventListeners(),f.setEventListeners(),k.setEventListeners();const E=new class extends d{constructor(t,e){super(t),this._callback=e,this._button=this._popup.querySelector(".popup__button"),this._buttonText=this._button.textContent,this._cardId=null,this._deleteCard=null}open=(t,e)=>{super.open(),this._cardId=t,this._deleteCard=e};setEventListeners(){super.setEventListeners(),this._button.addEventListener("click",(()=>{this._callback(this._cardId,this._deleteCard)}))}setButtonPending(){this._button.textContent=`${this._buttonText}...`,this._button.disabled=!0}resetButton(){this._button.textContent=this._buttonText,this._button.disabled=!1}}("#cardDelete",(function(t,e){E.setButtonPending(),u.deleteCard(t).then((t=>{e(),E.close()})).catch((t=>{console.log(t)})).finally((()=>{E.resetButton()}))}));function v(t,e,s,i){i?u.deleteLike(t).then((t=>{e(t.likes),s()})).catch((t=>{console.log(t)})):u.addLike(t).then((t=>{e(t.likes),s()})).catch((t=>{console.log(t)}))}E.setEventListeners(),u.getProfile().then((t=>{m.setUserInfo(t.name,t.about,t.avatar,t._id)})).catch((t=>{console.log(t)})),u.getInitialCards().then((t=>{b.renderElements(t)})).catch((t=>{console.log(t)})),t.addEventListener("click",(()=>{f.open(),f.setInputValues(m.getUserInfo()),_[r.getAttribute("name")].resetValidation()})),e.addEventListener("click",(()=>{k.open(),_[n.getAttribute("name")].resetValidation()})),s.addEventListener("click",(()=>{C.open(),_[o.getAttribute("name")].resetValidation()}))})();