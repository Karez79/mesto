(()=>{"use strict";const t=document.querySelector(".profile__edit-button"),e=document.querySelector(".profile__avatar-button"),s=document.querySelector(".profile__add-button"),r=document.querySelector("#cardTemplate"),i=document.querySelector("#profileForm"),n=document.querySelector("#avatarForm"),o=document.querySelector("#cardform");class a{constructor(t,e,s,r,i,n){this._photoCard=t,this._photoCardId=t._id,this._likes=t.likes,this._ownerId=this._photoCard.owner._id,this._cardTemplate=e,this._openZoomPhoto=s,this._handleLike=r,this._handleDeleteCard=i,this._userId=n,this._templateCard=this._defineCard(),this._cardLikesCounter=this._templateCard.querySelector(".card__info-likes-counter"),this._cardHeading=this._templateCard.querySelector(".card__info-title"),this._cardImage=this._templateCard.querySelector(".cards__image"),this._deleteButtonCard=this._templateCard.querySelector(".cards__delete-photo"),this._likeButton=this._templateCard.querySelector(".card__info-likes-button")}_defineCard(){return this._cardTemplate.content.querySelector(".card").cloneNode(!0)}_defineDeleteButton(){this._ownerId!==this._userId&&(this._deleteButtonCard.classList.add("cards__delete-photo_invisible"),this._deleteButtonCard.disabled=!0)}_isCardLiked(){return Boolean(this._likes.find((t=>t._id===this._userId)))}_defineLikeButton(){this._isCardLiked()&&this._likeButton.classList.add("card__info-likes-button_active")}_setCardElements(){this._cardHeading.textContent=this._photoCard.name,this._cardImage.setAttribute("src",this._photoCard.link),this._cardImage.setAttribute("alt",this._photoCard.name)}_setLikesCounter(){this._cardLikesCounter.textContent=this._likes.length}_changeLikesCounter=t=>{this._likes=t,this._cardLikesCounter.textContent=this._likes.length};_changeLikeStatus=()=>{this._likeButton.classList.toggle("card__info-likes-button_active")};_handleDeleteButtonClick=()=>{this._templateCard.remove(),this._templateCard=null};_handleOpenZoomClick(){this._openZoomPhoto(this._photoCard)}_addListeners(){this._likeButton.addEventListener("click",(t=>{this._isCardLiked()?this._handleLike(this._photoCardId,this._changeLikesCounter,this._changeLikeStatus,!0):this._handleLike(this._photoCardId,this._changeLikesCounter,this._changeLikeStatus,!1)})),this._deleteButtonCard.addEventListener("click",(()=>{this._handleDeleteCard(this._photoCardId,this._handleDeleteButtonClick)})),this._cardImage.addEventListener("click",(()=>{this._handleOpenZoomClick()}))}createCard(){return this._defineCard(),this._setCardElements(),this._setLikesCounter(),this._defineDeleteButton(),this._defineLikeButton(),this._addListeners(),this._templateCard}}class d{constructor(t,e){this._inputSelector=t.inputSelector,this._submitButtonSelector=t.submitButtonSelector,this._inactiveButtonClass=t.inactiveButtonClass,this._textErrorClass=t.textErrorClass,this._errorClass=t.errorClass,this._form=e}_defineElements(){this._inputList=this._form.querySelectorAll(this._inputSelector),this._submitButton=this._form.querySelector(this._submitButtonSelector)}_showInputError(t,e,s){t.classList.add(this._errorClass),e.textContent=s}_hideInputError(t,e){t.classList.remove(this._errorClass),e.textContent=""}_enableButton(){this._submitButton.classList.remove(this._inactiveButtonClass),this._submitButton.disabled=!1}disableButton(){this._submitButton.classList.add(this._inactiveButtonClass),this._submitButton.disabled=!0}_getErrorElement(t){return this._form.querySelector(`${this._textErrorClass}${t.name}`)}_checkInputValidity(t){t.validity.valid?this._hideInputError(t,this._getErrorElement(t)):this._showInputError(t,this._getErrorElement(t),t.validationMessage)}_getInvalidInputs(){return 0===[...this._inputList].filter((t=>!t.validity.valid)).length}_toggleButton(){this._getInvalidInputs()?this._enableButton():this.disableButton()}_setEventListeners(){this._inputList.forEach((t=>{t.addEventListener("input",(()=>{this._checkInputValidity(t),this._toggleButton()}))}))}hideErrors(){this._inputList.forEach((t=>{this._hideInputError(t,this._getErrorElement(t))}))}enableValidation(){this._defineElements(),this._setEventListeners()}resetValidation(){this.hideErrors(),this.disableButton()}}class h{constructor(t){this._popup=document.querySelector(t)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){document.removeEventListener("keydown",this._handleEscClose),this._popup.classList.remove("popup_opened")}_handleEscClose=t=>{"Escape"===t.key&&this.close()};setEventListeners(){this._popup.addEventListener("mousedown",(t=>{const e=e=>t.target.classList.contains(e);(e("popup_opened")||e("popup__close"))&&this.close()}))}}class u extends h{constructor(t,e){super(t),this._submitFormCallback=e,this._form=this._popup.querySelector("form"),this._inputs=this._form.querySelectorAll("input"),this._submitButton=this._form.querySelector(".popup__button"),this._submitButtonText=this._submitButton.textContent}_getInputValues(){const t={};return this._inputs.forEach((e=>{t[e.name]=e.value})),t}setInputValues(t){this._inputs.forEach((e=>{e.value=t[e.name]}))}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault(),this._submitFormCallback(this._getInputValues())}))}renderLoading(t,e){this._submitButton.disabled=t,this._submitButton.textContent=e||this._submitButtonText}close(){super.close(),this._form.reset()}}const _=new class{constructor(t){this._baseUrl=t.baseUrl,this._headers=t.headers}_checkRes(t){return t.ok?t.json():Promise.reject(new Error(`Ошибка: ${t.status}`))}_request(t,e){const s=`${this._baseUrl}/${t}`;return fetch(s,e).then(this._checkRes)}getProfile(){return this._request("users/me",{method:"GET",headers:this._headers})}editProfile(t){return this._request("users/me",{method:"PATCH",headers:this._headers,body:JSON.stringify({name:t.name,about:t.about})})}editAvatar(t){return this._request("users/me/avatar",{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:t})})}getInitialCards(){return this._request("cards",{method:"GET",headers:this._headers})}addCard(t){return this._request("cards",{method:"POST",headers:this._headers,body:JSON.stringify({name:t.name,link:t.link})})}deleteCard(t){return this._request(`cards/${t}`,{method:"DELETE",headers:this._headers})}addLike(t){return this._request(`cards/${t}/likes`,{method:"PUT",headers:this._headers})}deleteLike(t){return this._request(`cards/${t}/likes`,{method:"DELETE",headers:this._headers})}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-65",headers:{authorization:"bad0a43e-1805-4faf-8465-a8ef0cb6b6aa","Content-Type":"application/json"}}),l={};var c;c={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",textErrorClass:".popup__input-error_type_",errorClass:"popup__input_error"},Array.from(document.querySelectorAll(c.formSelector)).forEach((t=>{const e=new d(c,t),s=t.getAttribute("name");l[s]=e,e.enableValidation()}));const p=new class extends h{constructor(t){super(t),this._title=this._popup.querySelector(".popup__title-zoom"),this._image=this._popup.querySelector(".popup__zoom")}open=({name:t,link:e})=>{this._title.textContent=t,this._image.alt=t,this._image.src=e,super.open()}}("#zoomfoto");p.setEventListeners();const m=new class{constructor({nameId:t,aboutId:e,avatarId:s}){this._name=document.querySelector(t),this._about=document.querySelector(e),this._avatar=document.querySelector(s)}getUserInfo(){return{name:this._name.textContent,about:this._about.textContent,userId:this._userId}}getUserId(){return this._userId}setUserInfo=({name:t,about:e,avatar:s,_id:r})=>{this._name.textContent=t,this._about.textContent=e,this.setAvatar(s),this._userId=r};setAvatar=t=>{this._avatar.src=t}}({nameId:".profile__name",aboutId:".profile__about",avatarId:".profile__avatar"}),C=new class{constructor({renderer:t},e){this._renderer=t,this._container=document.querySelector(e)}renderElements=t=>{t.forEach((t=>{this._container.append(this._renderer(t))}))};addItem(t){this._container.prepend(this._renderer(t))}}({renderer:function(t){return new a(t,r,p.open,v,L.open,m.getUserId()).createCard()}},".cards"),b=new u("#cardADD",(function(t){k((function(){return _.addCard(t).then((t=>{C.addItem(t)}))}),b)})),f=new u("#profileEdit",(function(t){k((function(){return _.editProfile(t).then((t=>{m.setUserInfo(t)}))}),f)})),E=new u("#avatarEdit",(function(t){k((function(){return _.editAvatar(t.avatar).then((t=>{m.setAvatar(t.avatar)}))}),E)}));b.setEventListeners(),f.setEventListeners(),E.setEventListeners();const L=new class extends h{constructor(t,e){super(t),this._callback=e,this._button=this._popup.querySelector(".popup__button"),this._buttonText=this._button.textContent,this._cardId=null,this._deleteCard=null}open=(t,e)=>{super.open(),this._cardId=t,this._deleteCard=e};setEventListeners(){super.setEventListeners(),this._button.addEventListener("click",(()=>{this._callback(this._cardId,this._deleteCard)}))}renderLoading(t,e){this._button.disabled=t,this._button.textContent=e||this._buttonText}}("#cardDelete",(function(t,e){k((function(){return _.deleteCard(t).then((()=>{e()}))}),L,"Удаление...")}));function k(t,e,s="Сохранение..."){e.renderLoading(!0,s),t().then((()=>{e.close()})).catch((t=>{console.error(`Ошибка: ${t}`)})).finally((()=>{e.renderLoading(!1)}))}function v(t,e,s,r){r?_.deleteLike(t).then((t=>{e(t.likes),s()})).catch((t=>{console.log(t)})):_.addLike(t).then((t=>{e(t.likes),s()})).catch((t=>{console.log(t)}))}L.setEventListeners(),Promise.all([_.getProfile(),_.getInitialCards()]).then((([t,e])=>{m.setUserInfo(t),C.renderElements(e)})).catch((t=>{console.log(t)})),t.addEventListener("click",(()=>{f.open(),f.setInputValues(m.getUserInfo()),l[i.getAttribute("name")].resetValidation()})),e.addEventListener("click",(()=>{E.open(),l[n.getAttribute("name")].resetValidation()})),s.addEventListener("click",(()=>{b.open(),l[o.getAttribute("name")].resetValidation()}))})();